<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Upload Tester</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
      }
      .upload-section {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
      }
      h2 {
        margin-top: 0;
      }
      .file-status {
        margin-top: 10px;
      }
      .file-status.success {
        color: green;
      }
      .file-status.error {
        color: red;
      }
      .file-status.processing {
        color: orange;
      }
      .file-item {
        margin-bottom: 15px;
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 5px;
      }
      .file-item span {
        margin-left: 10px;
      }
      .file-item img {
        display: block;
        margin-top: 10px;
        max-width: 100%;
        height: auto;
      }
      .file-item video {
        display: block;
        margin-top: 10px;
        max-width: 100%;
        height: auto;
      }
      .retry-section {
        margin-top: 30px;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
      }
      button {
        padding: 8px 16px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #45a049;
      }
      input[type="file"] {
        margin-bottom: 10px;
      }
      input[type="text"] {
        padding: 8px;
        margin-right: 10px;
        width: 250px;
      }
      .debug-info {
        margin-top: 20px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .preview-image {
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
      }
      .preview-video {
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
      }
      .file-links {
        margin-top: 10px;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 4px;
      }
      .file-links a {
        display: block;
        margin-bottom: 5px;
        color: #0066cc;
        text-decoration: none;
      }
      .file-links a:hover {
        text-decoration: underline;
      }
      .file-id {
        font-family: monospace;
        background-color: #eee;
        padding: 2px 5px;
        border-radius: 3px;
      }
      .video-container {
        position: relative;
        margin-top: 10px;
      }
      .video-thumbnail {
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
      }
      .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        background-color: rgba(0, 0, 0, 0.7);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
      }
      .play-button:after {
        content: '';
        display: block;
        width: 0;
        height: 0;
        border-top: 15px solid transparent;
        border-bottom: 15px solid transparent;
        border-left: 25px solid white;
        margin-left: 5px;
      }
      .watermarked-video-container {
        position: relative;
        margin-top: 10px;
        width: 100%;
      }
      .video-watermark-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        background-color: rgba(0, 0, 0, 0.1);
      }
      .video-watermark-text {
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 24px;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }
      .custom-video-player {
        position: relative;
        width: 100%;
        max-width: 100%;
        margin-top: 10px;
        overflow: hidden;
      }
      .custom-video-player video {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .custom-video-watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        pointer-events: none;
        width: 150px;
        height: auto;
        opacity: 0.7;
      }
      .processing-note {
        background-color: #fff3cd;
        color: #856404;
        padding: 15px;
        margin-top: 15px;
        border-radius: 4px;
        border: 1px solid #ffeeba;
        font-size: 14px;
        line-height: 1.5;
      }
      .processing-note.warning {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
      }
      .processing-note h3 {
        margin-top: 0;
        margin-bottom: 10px;
      }
      .processing-note code {
        background-color: rgba(0,0,0,0.1);
        padding: 2px 5px;
        border-radius: 3px;
        font-family: monospace;
      }
      .fullscreen-watermark {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        pointer-events: none;
        width: 200px;
        height: auto;
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <h1>File Upload Tester</h1>
    
    <div class="container">
      <div class="upload-section">
        <h2>Upload Image</h2>
        <form id="imageUploadForm" method="post" enctype="multipart/form-data">
          <input type="file" name="file" accept="image/*" />
          <button type="submit">Upload Image</button>
        </form>
        <div id="imageStatusContainer"></div>
      </div>
      
      <div class="upload-section">
        <h2>Upload Video</h2>
        <form id="videoUploadForm" method="post" enctype="multipart/form-data">
          <input type="file" name="file" accept="video/*" />
          <button type="submit">Upload Video</button>
        </form>
        <div id="videoStatusContainer"></div>
      </div>
    </div>
    
    <div class="upload-section">
      <h2>Multiple Files Upload</h2>
      <form id="multipleUploadForm" method="post" enctype="multipart/form-data">
        <input type="file" name="files" multiple />
        <button type="submit">Upload Files</button>
      </form>
      <div id="multipleStatusContainer"></div>
    </div>
    
    <div class="retry-section">
      <h2>Retry Processing</h2>
      <form id="retryForm" method="post">
        <input type="text" id="fileId" placeholder="Enter File ID to retry" />
        <button type="submit">Retry Processing</button>
      </form>
      <div id="retryStatusContainer"></div>
    </div>
    
    <div class="debug-info" id="debugInfo"></div>

    <script>
      // Add this function at the beginning of the script section, before any event handlers
      function createVideoPlayer(url, fileInfoDiv, fileItem, hasProcessingNote) {
        // Create a custom video player container
        const playerContainer = document.createElement("div");
        playerContainer.className = "custom-video-player";
        
        // Create the video element
        const video = document.createElement("video");
        video.controls = true;
        video.className = "preview-video";
        video.crossOrigin = "anonymous"; // Enable CORS for the video
        
        const source = document.createElement("source");
        source.src = url;
        source.type = "video/mp4";
        
        video.appendChild(source);
        video.onerror = function() {
          fileInfoDiv.innerHTML += `<p class="error">Error loading video. <a href="${url}" target="_blank">Try direct link</a></p>`;
        };
        
        // Add the video to the container
        playerContainer.appendChild(video);
        
        // Create a canvas element that will be used to draw the video and watermark
        const canvas = document.createElement("canvas");
        canvas.style.display = "none";
        playerContainer.appendChild(canvas);
        
        // Load the watermark image
        const watermarkImg = new Image();
        watermarkImg.src = "/watermark.png"; // Path to your actual watermark
        watermarkImg.className = "custom-video-watermark";
        
        // Add the watermark image as a visible overlay
        playerContainer.appendChild(watermarkImg);
        
        // Handle fullscreen changes
        video.addEventListener('webkitfullscreenchange', function() {
          handleFullscreenChange(video, watermarkImg);
        });
        video.addEventListener('mozfullscreenchange', function() {
          handleFullscreenChange(video, watermarkImg);
        });
        video.addEventListener('fullscreenchange', function() {
          handleFullscreenChange(video, watermarkImg);
        });
        
        // Add the player to the file item
        fileItem.appendChild(playerContainer);
        
        // Display processing note if available
        if (hasProcessingNote) {
          const noteDiv = document.createElement("div");
          noteDiv.className = "processing-note";
          noteDiv.style.backgroundColor = "#fff3cd";
          noteDiv.style.color = "#856404";
          noteDiv.style.padding = "10px";
          noteDiv.style.marginTop = "10px";
          noteDiv.style.borderRadius = "4px";
          noteDiv.style.border = "1px solid #ffeeba";
          noteDiv.textContent = "Original video returned without embedded watermark - ffmpeg not available";
          fileItem.appendChild(noteDiv);
        }
        
        return playerContainer;
      }

      // Function to handle fullscreen changes
      function handleFullscreenChange(video, watermarkImg) {
        const isFullScreen = document.fullscreenElement || 
                            document.webkitFullscreenElement || 
                            document.mozFullScreenElement;
        
        // Remove any existing fullscreen watermark
        const existingWatermark = document.getElementById("fullscreen-watermark");
        if (existingWatermark) {
          document.body.removeChild(existingWatermark);
        }
        
        if (isFullScreen) {
          // Create a new watermark for the fullscreen element
          const fullscreenWatermark = document.createElement('img');
          fullscreenWatermark.src = watermarkImg.src;
          fullscreenWatermark.className = "fullscreen-watermark";
          fullscreenWatermark.id = "fullscreen-watermark";
          
          // Add the watermark to the document body
          document.body.appendChild(fullscreenWatermark);
          
          // Add a listener for when the video exits fullscreen
          const exitHandler = function() {
            if (!document.fullscreenElement && 
                !document.webkitFullscreenElement && 
                !document.mozFullScreenElement) {
              const fullscreenWatermark = document.getElementById("fullscreen-watermark");
              if (fullscreenWatermark) {
                document.body.removeChild(fullscreenWatermark);
              }
              
              // Remove the event listeners
              document.removeEventListener('fullscreenchange', exitHandler);
              document.removeEventListener('webkitfullscreenchange', exitHandler);
              document.removeEventListener('mozfullscreenchange', exitHandler);
            }
          };
          
          // Add event listeners for fullscreen change
          document.addEventListener('fullscreenchange', exitHandler);
          document.addEventListener('webkitfullscreenchange', exitHandler);
          document.addEventListener('mozfullscreenchange', exitHandler);
        }
      }

      // Image upload handler
      document.getElementById("imageUploadForm").addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const file = formData.get("file");
        if (!file || file.size === 0) {
          alert("Please select an image file to upload");
          return;
        }
        
        const statusContainer = document.getElementById("imageStatusContainer");
        statusContainer.innerHTML = "";
        
        const fileItem = createFileItem(file.name);
        statusContainer.appendChild(fileItem);
        
        uploadFile(file, fileItem, "/image", "image");
      });
      
      // Video upload handler
      document.getElementById("videoUploadForm").addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const file = formData.get("file");
        if (!file || file.size === 0) {
          alert("Please select a video file to upload");
          return;
        }
        
        const statusContainer = document.getElementById("videoStatusContainer");
        statusContainer.innerHTML = "";
        
        const fileItem = createFileItem(file.name);
        statusContainer.appendChild(fileItem);
        
        uploadFile(file, fileItem, "/video", "video");
      });
      
      // Multiple files upload handler
      document.getElementById("multipleUploadForm").addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const fileInput = event.target.querySelector('input[type="file"]');
        const files = fileInput.files;
        
        if (!files || files.length === 0) {
          alert("Please select at least one file to upload");
          return;
        }
        
        const statusContainer = document.getElementById("multipleStatusContainer");
        statusContainer.innerHTML = "";
        
        // Process each file individually
        Array.from(files).forEach(file => {
          const fileItem = createFileItem(file.name);
          statusContainer.appendChild(fileItem);
          
          // Determine endpoint based on file type
          let endpoint = "/createPreview";
          let fileType = getFileType(file.type);
          
          if (fileType === "image") {
            endpoint = "/image";
          } else if (fileType === "video") {
            endpoint = "/video";
          }
          
          uploadFile(file, fileItem, endpoint, fileType);
        });
      });
      
      // Retry form handler
      document.getElementById("retryForm").addEventListener("submit", function (event) {
        event.preventDefault();
        const fileId = document.getElementById("fileId").value.trim();
        if (!fileId) {
          alert("Please enter a file ID");
          return;
        }
        
        const statusContainer = document.getElementById("retryStatusContainer");
        statusContainer.innerHTML = "";
        
        const fileItem = document.createElement("div");
        fileItem.classList.add("file-item");
        fileItem.innerHTML = `
          <strong>Retrying file ID: ${fileId}</strong> 
          <span class="file-status processing">Processing...</span>
        `;
        statusContainer.appendChild(fileItem);
        
        retryProcessing(fileId, fileItem);
      });
      
      function createFileItem(fileName) {
        const fileItem = document.createElement("div");
        fileItem.classList.add("file-item");
        fileItem.innerHTML = `
          <strong>${fileName}</strong> 
          <span class="file-status processing">Processing...</span>
        `;
        return fileItem;
      }
      
      function getFileType(mimeType) {
        if (mimeType.startsWith("image/")) return "image";
        if (mimeType.startsWith("video/")) return "video";
        return "unknown";
      }

      function uploadFile(file, fileItem, endpoint, fileType) {
        const formData = new FormData();
        formData.append("file", file);

        // Show that we're sending the request
        document.getElementById("debugInfo").textContent = `Sending ${fileType} to ${endpoint}...`;

        fetch(endpoint, {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((result) => {
            // Log the result for debugging
            console.log("Upload result:", result);
            document.getElementById("debugInfo").textContent = "Last response: " + JSON.stringify(result, null, 2);
            
            const statusElement = fileItem.querySelector(".file-status");
            if (result.url) {
              statusElement.textContent = "Completed";
              statusElement.classList.remove("processing");
              statusElement.classList.add("success");
              
              // Add file info
              const fileInfoDiv = document.createElement("div");
              fileInfoDiv.className = "file-links";
              fileInfoDiv.innerHTML = `
                <a href="${result.url}" target="_blank">View Preview</a>
                <a href="${result.originalUrl}" target="_blank">View Original File</a>
                <p>File ID: <span class="file-id">${result.fileId}</span></p>
              `;
              fileItem.appendChild(fileInfoDiv);
              
              // Add preview based on file type
              if (fileType === "image") {
                const img = document.createElement("img");
                img.src = result.url;
                img.alt = "Uploaded Image";
                img.className = "preview-image";
                img.onerror = function() {
                  this.onerror = null;
                  this.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiPkltYWdlIGxvYWQgZXJyb3I8L3RleHQ+PC9zdmc+";
                  fileInfoDiv.innerHTML += `<p class="error">Error loading image. <a href="${result.url}" target="_blank">Try direct link</a></p>`;
                };
                fileItem.appendChild(img);
              } else if (fileType === "video") {
                // Check if we have a thumbnail from the server
                if (result.thumbnailData) {
                  // Create a container for the video thumbnail and play button
                  const videoContainer = document.createElement("div");
                  videoContainer.className = "video-container";
                  
                  // Create the thumbnail image
                  const thumbnailImg = document.createElement("img");
                  thumbnailImg.src = `data:image/jpeg;base64,${result.thumbnailData}`;
                  thumbnailImg.alt = "Video Thumbnail";
                  thumbnailImg.className = "video-thumbnail";
                  
                  // Create the play button overlay
                  const playButton = document.createElement("div");
                  playButton.className = "play-button";
                  
                  // Add click handler to play the video
                  videoContainer.addEventListener("click", function() {
                    // Create the video player with our custom function
                    const playerContainer = createVideoPlayer(result.url, fileInfoDiv, fileItem, result.processingNote);
                    
                    // Replace the container with the player
                    videoContainer.parentNode.replaceChild(playerContainer, videoContainer);
                    
                    // Find the video element and play it
                    const video = playerContainer.querySelector('video');
                    if (video) {
                      video.play().catch(e => console.error("Error playing video:", e));
                    }
                  });
                  
                  // Assemble the container
                  videoContainer.appendChild(thumbnailImg);
                  videoContainer.appendChild(playButton);
                  fileItem.appendChild(videoContainer);
                  
                  // Display processing note if available
                  if (result.processingNote) {
                    const noteDiv = document.createElement("div");
                    noteDiv.className = "processing-note warning";
                    
                    // Check if the note is about ffmpeg
                    if (result.processingNote.includes("ffmpeg not available")) {
                      noteDiv.innerHTML = `
                        <h3>⚠️ FFmpeg Not Available</h3>
                        <p>${result.processingNote}</p>
                        <p><strong>Installation Instructions:</strong></p>
                        <ul>
                          <li><strong>macOS:</strong> <code>brew install ffmpeg</code></li>
                          <li><strong>Ubuntu/Debian:</strong> <code>sudo apt update && sudo apt install ffmpeg</code></li>
                          <li><strong>Windows:</strong> Download from <a href="https://ffmpeg.org/download.html" target="_blank">ffmpeg.org</a> and add to PATH</li>
                        </ul>
                        <p>After installing, restart the server to enable video watermarking.</p>
                      `;
                    } else {
                      noteDiv.textContent = result.processingNote;
                    }
                    
                    fileItem.appendChild(noteDiv);
                  }
                } else {
                  // No thumbnail, just show the video player with our custom function
                  createVideoPlayer(result.url, fileInfoDiv, fileItem, result.processingNote);
                }
              }
            } else {
              statusElement.textContent = "Failed: " + (result.error || "Unknown error");
              statusElement.classList.remove("processing");
              statusElement.classList.add("error");
              
              if (result.fileId && result.canRetry) {
                const fileInfoDiv = document.createElement("div");
                fileInfoDiv.className = "file-links";
                fileInfoDiv.innerHTML = `
                  <p>File ID for retry: <span class="file-id">${result.fileId}</span></p>
                `;
                if (result.originalUrl) {
                  fileInfoDiv.innerHTML += `<a href="${result.originalUrl}" target="_blank">View Original File</a>`;
                }
                fileItem.appendChild(fileInfoDiv);
              }
            }
          })
          .catch((error) => {
            console.error("Upload error:", error);
            document.getElementById("debugInfo").textContent = "Error: " + error.message;
            
            const statusElement = fileItem.querySelector(".file-status");
            statusElement.textContent = "Failed: " + error.message;
            statusElement.classList.remove("processing");
            statusElement.classList.add("error");
          });
      }
      
      function retryProcessing(fileId, fileItem) {
        // Show that we're sending the request
        document.getElementById("debugInfo").textContent = `Sending retry request for ${fileId}...`;

        fetch("/retry", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ fileId }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((result) => {
            // Log the result for debugging
            console.log("Retry result:", result);
            document.getElementById("debugInfo").textContent = "Last response: " + JSON.stringify(result, null, 2);
            
            const statusElement = fileItem.querySelector(".file-status");
            if (result.url) {
              statusElement.textContent = "Retry Successful";
              statusElement.classList.remove("processing");
              statusElement.classList.add("success");
              
              // Add file info
              const fileInfoDiv = document.createElement("div");
              fileInfoDiv.className = "file-links";
              fileInfoDiv.innerHTML = `
                <a href="${result.url}" target="_blank">View Preview</a>
                <a href="${result.originalUrl}" target="_blank">View Original File</a>
                <p>File ID: <span class="file-id">${result.fileId}</span></p>
              `;
              fileItem.appendChild(fileInfoDiv);
              
              // Check if we have a thumbnail from the server
              if (result.thumbnailData) {
                // Create a container for the video thumbnail and play button
                const videoContainer = document.createElement("div");
                videoContainer.className = "video-container";
                
                // Create the thumbnail image
                const thumbnailImg = document.createElement("img");
                thumbnailImg.src = `data:image/jpeg;base64,${result.thumbnailData}`;
                thumbnailImg.alt = "Video Thumbnail";
                thumbnailImg.className = "video-thumbnail";
                
                // Create the play button overlay
                const playButton = document.createElement("div");
                playButton.className = "play-button";
                
                // Add click handler to play the video
                videoContainer.addEventListener("click", function() {
                  // Create the video player with our custom function
                  const playerContainer = createVideoPlayer(result.url, fileInfoDiv, fileItem, result.processingNote);
                  
                  // Replace the container with the player
                  videoContainer.parentNode.replaceChild(playerContainer, videoContainer);
                  
                  // Find the video element and play it
                  const video = playerContainer.querySelector('video');
                  if (video) {
                    video.play().catch(e => console.error("Error playing video:", e));
                  }
                });
                
                // Assemble the container
                videoContainer.appendChild(thumbnailImg);
                videoContainer.appendChild(playButton);
                fileItem.appendChild(videoContainer);
              } else if (result.url.endsWith('.mp4')) {
                // Create video player with our custom function
                createVideoPlayer(result.url, fileInfoDiv, fileItem, result.processingNote);
              } else if (result.url.endsWith('.webp') || result.url.endsWith('.jpg') || result.url.endsWith('.png')) {
                const img = document.createElement("img");
                img.src = result.url;
                img.alt = "Processed Image";
                img.className = "preview-image";
                img.onerror = function() {
                  this.onerror = null;
                  this.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiPkltYWdlIGxvYWQgZXJyb3I8L3RleHQ+PC9zdmc+";
                  fileInfoDiv.innerHTML += `<p class="error">Error loading image. <a href="${result.url}" target="_blank">Try direct link</a></p>`;
                };
                fileItem.appendChild(img);
              }
            } else {
              statusElement.textContent = "Retry Failed: " + (result.error || "Unknown error");
              statusElement.classList.remove("processing");
              statusElement.classList.add("error");
            }
          })
          .catch((error) => {
            console.error("Retry error:", error);
            document.getElementById("debugInfo").textContent = "Error: " + error.message;
            
            const statusElement = fileItem.querySelector(".file-status");
            statusElement.textContent = "Retry Failed: " + error.message;
            statusElement.classList.remove("processing");
            statusElement.classList.add("error");
          });
      }
    </script>
  </body>
</html>
